{% extends "base.html" %}

{% block title %}{{ data.name or "Liturgical Calendar" }} - {{ date.strftime('%B %d, %Y') }}{% endblock %}

{% block content %}
<div class="header">
    {% if data.season %}
    <div class="header-season">{{ data.season }} â€” <span class="header-date">{{ date.strftime('%-d %B, %Y') }}</span></div>
    {% else %}
    <div class="header-date">{{ date.strftime('%-d %B, %Y') }}</div>
    {% endif %}
</div>

<div class="content">

    {% if artwork_info %}
    <div class="image-section">
        <img src="/api/artwork/{{ date.strftime('%Y-%m-%d') }}" alt="Liturgical Artwork for {{ date.strftime('%B %d, %Y') }}" class="liturgical-image">
    </div>
    {% elif next_artwork %}
    <a href="/date/{{ next_artwork.date_obj.strftime('%Y-%m-%d') if next_artwork.date_obj else '' }}" class="image-section next-artwork-section">
        <div class="next-artwork-container">
            <img src="/api/next-artwork/{{ date.strftime('%Y-%m-%d') }}" alt="Next Liturgical Artwork: {{ next_artwork.name }}" class="liturgical-image next-artwork-thumbnail">
            <div class="next-artwork-label-wrapper">
                <div class="next-prefix">NEXT:</div>

                <div class="next-artwork-label">
                    <span class="next-artwork-title">{{ next_artwork.name }}</span>
                    {% if next_artwork.date %}
                    <div class="next-artwork-date">{{ next_artwork.date.upper() }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </a>
    {% endif %}

    {% if data.name %}
    <div class="feast-title">{{ data.name }}</div>
    {% else %}
    <div class="feast-title">{{ date.strftime('%A') }}</div>
    {% endif %}


    {% if data.readings %}
    <div class="readings">
        {% if data.week %}
        <h3>{{ data.week.upper() }}</h3>
        {% endif %}
        <ul>
            {% for reading in data.readings %}
                {% if reading.is_alternative %}
                <li class="alternative-reading">
                    {% for alt in reading.alternatives %}
                        {% if alt.parsed %}
                        <a href="#" class="reading-link" data-reading="{{ alt.reference }}">{{ alt.reference }}</a>
                        {% else %}
                        <span class="reading-failed">{{ alt.reference }}</span>
                        {% endif %}
                        {% if not loop.last %}<span class="or-separator"> or </span>{% endif %}
                    {% endfor %}
                </li>
                {% else %}
                    {% if reading.parsed %}
                    <li><a href="#" class="reading-link" data-reading="{{ reading.reference }}">{{ reading.reference }}</a></li>
                    {% else %}
                    <li><span class="reading-failed">{{ reading.reference }}</span></li>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if reflection %}
    <div class="wikipedia-summary">
        {% for paragraph in reflection.reflection.split('\n\n') %}
        <p>{{ paragraph }}</p>
        {% endfor %}
        
    {% if reflection.prayer %}
        <div class="prayer-text">
            {% for line in reflection.prayer.split('\n') %}
            <p>{{ line }}</p>
            {% endfor %}
        </div>
    {% endif %}
        
        {% if data.url %}
        <a href="{{ data.url }}" class="wikipedia-link" target="_blank">
            Read more on Wikipedia
        </a>
        {% endif %}
    </div>
    {% elif wikipedia_summary %}
    <div class="wikipedia-summary">
        <p>{{ wikipedia_summary.extract }}</p>
        {% if wikipedia_summary.content_url %}
        <a href="{{ wikipedia_summary.content_url }}" class="wikipedia-link" target="_blank">
            Read more on Wikipedia
        </a>
        {% endif %}
    </div>
    {% endif %}

    <ul class="api-links">
        <li><a href="/api/info/{{ date.strftime('%Y-%m-%d') }}">JSON</a></li>
        {% if artwork_info %}
        <li><a href="/api/artwork/{{ date.strftime('%Y-%m-%d') }}">Cached Art</a></li>
        {% if artwork_info.source %}
        <li><a href="{{ artwork_info.source }}" target="_blank">Original on Instagram</a></li>
        {% endif %}
        {% endif %}
        <li><a href="/api/image/{{ date.strftime('%Y-%m-%d') }}/png">ePaper PNG</a></li>
        <li><a href="/api/image/{{ date.strftime('%Y-%m-%d') }}/bmp">ePaper BMP</a></li>
        {% if reflection %}
        <li><a href="/api/reflection/{{ date.strftime('%Y-%m-%d') }}">Reflection JSON</a></li>
        {% endif %}
        <li><a href="/today">Go to Today</a></li>
    </ul>
</div>

<!-- Reading Content Modal -->
<div id="readingModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="modalTitle">Reading</h3>
        <div id="modalContent">
            <div class="loading">Loading reading content...</div>
        </div>
    </div>
</div>

<script>
// Reading modal functionality
const modal = document.getElementById('readingModal');
const modalTitle = document.getElementById('modalTitle');
const modalContent = document.getElementById('modalContent');
const closeBtn = document.getElementsByClassName('close')[0];

// Format plain text reading into HTML with verse structure
function formatReadingText(plainText) {
    if (!plainText || plainText.startsWith('[Reading:')) {
        return plainText;
    }
    
    // Split by verse numbers (digits followed by space)
    const parts = plainText.split(/(\d+ )/);
    
    if (parts.length < 2) {
        return plainText;
    }
    
    const formattedParts = [];
    for (let i = 0; i < parts.length; i++) {
        if (i + 1 < parts.length && /^\d+ $/.test(parts[i])) {
            // This is a verse number
            const verseNum = parts[i].trim();
            const verseText = parts[i + 1] || "";
            
            // Split verse text into words
            const words = verseText.split(' ');
            if (words.length >= 2) {
                const firstTwoWords = words.slice(0, 2).join(' ');
                const remainingWords = words.slice(2).join(' ');
                const remainingText = remainingWords ? ` ${remainingWords}` : '';
                
                formattedParts.push(
                    `<span class="verse"><span class="nowrap"><span class="verse-number">${verseNum}</span> ${firstTwoWords}</span>${remainingText}</span>`
                );
            } else {
                formattedParts.push(
                    `<span class="verse"><span class="nowrap"><span class="verse-number">${verseNum}</span> ${verseText}</span></span>`
                );
            }
            i++; // Skip the next part as we've processed it
        } else if (parts[i].trim()) {
            // Regular text
            formattedParts.push(parts[i]);
        }
    }
    
    // Join with spaces and wrap in paragraph
    const formattedText = formattedParts.join(' ');
    return `<p>${formattedText}</p>`;
}

// Open modal when reading link is clicked
document.querySelectorAll('.reading-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const reading = this.getAttribute('data-reading');
        modalTitle.textContent = reading;
        modalContent.innerHTML = '<div class="loading">Loading reading content...</div>';
        modal.style.display = 'block';
        
        // Fetch reading content
        fetch(`/api/reading/${encodeURIComponent(reading)}`)
            .then(response => response.json())
            .then(data => {
                if (data.text) {
                    const formattedText = formatReadingText(data.text);
                    modalContent.innerHTML = `<div class="reading-text">${formattedText}</div>`;
                } else {
                    modalContent.innerHTML = '<div class="error">Reading content not available</div>';
                }
            })
            .catch(error => {
                console.error('Error fetching reading:', error);
                modalContent.innerHTML = '<div class="error">Error loading reading content</div>';
            });
    });
});

// Close modal
closeBtn.onclick = function() {
    modal.style.display = 'none';
}

window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %} 