{% extends "base.html" %}

{% block title %}{{ data.name or "Liturgical Calendar" }} - {{ date.strftime('%B %d, %Y') }}{% endblock %}

{% block content %}
<div class="header">
    {% if data.season %}
    <div class="header-season">{{ data.season }} — <span class="header-date">{{ date.strftime('%-d %B, %Y') }}</span></div>
    {% else %}
    <div class="header-date">{{ date.strftime('%-d %B, %Y') }}</div>
    {% endif %}
</div>

<div class="content">

    {% if artwork_info %}
    <div class="image-section">
        <img src="/api/artwork/{{ date.strftime('%Y-%m-%d') }}" alt="Liturgical Artwork for {{ date.strftime('%B %d, %Y') }}" class="liturgical-image">
    </div>
    {% elif next_artwork %}
    <a href="/date/{{ next_artwork.date_obj.strftime('%Y-%m-%d') if next_artwork.date_obj else '' }}" class="image-section next-artwork-section">
        <div class="next-artwork-container">
            <img src="/api/next-artwork/{{ date.strftime('%Y-%m-%d') }}" alt="Next Liturgical Artwork: {{ next_artwork.name }}" class="liturgical-image next-artwork-thumbnail">
            <div class="next-artwork-label-wrapper">
                <div class="next-prefix">NEXT:</div>

                <div class="next-artwork-label">
                    <span class="next-artwork-title">{{ next_artwork.name }}</span>
                    {% if next_artwork.date %}
                    <div class="next-artwork-date">{{ next_artwork.date.upper() }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </a>
    {% endif %}

    {% if data.name %}
    <div class="feast-title">{{ data.name }}</div>
    {% else %}
    <div class="feast-title">{{ date.strftime('%A') }}</div>
    {% endif %}


    {% if data.readings %}
    <div class="readings">
        {% if data.week %}
        <h3>{{ data.week.upper() }}</h3>
        {% endif %}
        <ul>
            {% for reading in data.readings %}
            <li>{{ reading }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if wikipedia_summary %}
    <div class="wikipedia-summary">
        <p>{{ wikipedia_summary.extract }}</p>
        {% if wikipedia_summary.content_url %}
        <a href="{{ wikipedia_summary.content_url }}" class="wikipedia-link" target="_blank">
            Read more on Wikipedia
        </a>
        {% endif %}
    </div>
    {% endif %}

    <div class="reflection-section" id="reflection-section">
        <h3>Daily Reflection</h3>
        <div class="reflection-loading">Loading reflection...</div>
        <div class="reflection-content" id="reflection-content" style="display: none;">
            <div class="reflection-text" id="reflection-text"></div>
            <div class="reflection-meta">
                <small id="reflection-meta"></small>
            </div>
        </div>
        <div class="reflection-error" id="reflection-error" style="display: none;">
            <p>Unable to load reflection at this time.</p>
        </div>
    </div>

    <ul class="api-links">
        <li><a href="/api/info/{{ date.strftime('%Y-%m-%d') }}">JSON</a></li>
        {% if artwork_info %}
        <li><a href="/api/artwork/{{ date.strftime('%Y-%m-%d') }}">Cached Art</a></li>
        {% if artwork_info.source %}
        <li><a href="{{ artwork_info.source }}" target="_blank">Original on Instagram</a></li>
        {% endif %}
        {% endif %}
        <li><a href="/api/image/{{ date.strftime('%Y-%m-%d') }}/png">ePaper PNG</a></li>
        <li><a href="/api/image/{{ date.strftime('%Y-%m-%d') }}/bmp">ePaper BMP</a></li>
        <li><a href="/api/reflection/{{ date.strftime('%Y-%m-%d') }}">Reflection JSON</a></li>
        <li><a href="/today">Go to Today</a></li>
    </ul>
</div>

<script>
// Load reflection when page loads
document.addEventListener('DOMContentLoaded', function() {
    const dateStr = '{{ date.strftime('%Y-%m-%d') }}';
    const loadingEl = document.getElementById('reflection-loading');
    const contentEl = document.getElementById('reflection-content');
    const errorEl = document.getElementById('reflection-error');
    const textEl = document.getElementById('reflection-text');
    const metaEl = document.getElementById('reflection-meta');
    
    fetch(`/api/reflection/${dateStr}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Hide loading, show content
            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';
            
            // Set reflection text
            textEl.textContent = data.reflection;
            
            // Set metadata
            const metaParts = [];
            if (data.season) metaParts.push(data.season);
            if (data.tokens_used) metaParts.push(`${data.tokens_used} tokens`);
            if (data.generated_at) {
                const date = new Date(data.generated_at);
                metaParts.push(`Generated ${date.toLocaleString()}`);
            }
            metaEl.textContent = metaParts.join(' • ');
        })
        .catch(error => {
            console.error('Error loading reflection:', error);
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
        });
});
</script>
{% endblock %} 